name: Changesets (OIDC)

on:
  push:
    branches:
      - main

permissions:
  contents: write      # ç”¨äºåˆ›å»ºæ ‡ç­¾/æäº¤ç‰ˆæœ¬å˜æ›´
  pull-requests: write # ç”¨äºåˆ›å»ºç‰ˆæœ¬ PR
  id-token: write      # OIDC è®¤è¯å¿…éœ€ï¼ˆæ ¸å¿ƒæƒé™ï¼‰

env:
  CI: true
  NPM_REGISTRY: https://registry.npmjs.org
  SCOPE: '@cocojs'

jobs:
  version:
    timeout-minutes: 15
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # åŸºç¡€ checkout æƒé™

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          use-node-version: true # è‡ªåŠ¨å¤ç”¨åç»­ node ç‰ˆæœ¬

      - name: Setup Node.js + OIDC è®¤è¯
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          registry-url: ${{ env.NPM_REGISTRY }} # ç»‘å®š npm å®˜æ–¹æº
          scope: ${{ env.SCOPE }}              # å…³è”ä½ çš„åŒ…ä½œç”¨åŸŸ
          always-auth: true                    # å¼ºåˆ¶å¯ç”¨è®¤è¯ï¼ˆOIDC å¿…éœ€ï¼‰
          # ğŸ”¥ å…³é”®ï¼šOIDC æ— éœ€æ‰‹åŠ¨ä¼  tokenï¼Œsetup-node ä¼šè‡ªåŠ¨è·å–ä¸´æ—¶ä»¤ç‰Œæ³¨å…¥ NODE_AUTH_TOKEN

      - name: ğŸ” Debug è®¤è¯ç¯å¢ƒï¼ˆå¯é€‰ï¼Œç”¨äºéªŒè¯ï¼‰
        run: |
          echo "NODE_AUTH_TOKEN å­˜åœ¨æ€§: ${{ env.NODE_AUTH_TOKEN != '' }}"
          echo "pnpm é…ç½®çš„ä»“åº“åœ°å€: $(pnpm config get registry)"
          echo "ä½œç”¨åŸŸé…ç½®: $(pnpm config get @cocojs:registry)"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile # é”å®šä¾èµ–ç‰ˆæœ¬ï¼Œæå‡ç¨³å®šæ€§

      - name: Create and publish versions (OIDC ç‰ˆ)
        uses: changesets/action@v1
        with:
          commit: "chore: update versions [OIDC]"
          title: "chore: update versions (OIDC)"
          publish: pnpm ci:publish # ç¡®ä¿é¡¹ç›® package.json ä¸­æœ‰è¯¥è„šæœ¬ï¼ˆè§ä¸‹æ–¹è¯´æ˜ï¼‰
          onlyPublishWithReleaseLabel: false
        env:
          # ğŸ”‘ OIDC æ ¸å¿ƒï¼šsetup-node è‡ªåŠ¨æ³¨å…¥çš„ä¸´æ—¶ä»¤ç‰Œï¼Œpnpm ä¼šè‡ªåŠ¨è¯»å–
          NODE_AUTH_TOKEN: ${{ steps.setup-node.outputs.token }}
          # GitHub æ“ä½œæƒé™ä»¤ç‰Œï¼ˆç”¨äºåˆ›å»º PR/æ ‡ç­¾ï¼‰
          GITHUB_TOKEN: ${{ secrets.COCONUT_FRAMEWORK_CREATE_PR }}
