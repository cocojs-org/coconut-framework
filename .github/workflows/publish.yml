name: Changesets

on:
  push:
    branches:
      - main

permissions:
  id-token: write      # OIDC Token
  contents: write      # Push tags/releases
  pull-requests: write # Version PR

env:
  CI: true

jobs:
  version:
    timeout-minutes: 15
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # ä½¿ç”¨ GITHUB_TOKEN for basic checkout
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      # â¬‡ï¸ ä»…ä¾é  actions/setup-node è‡ªåŠ¨é…ç½® OIDC è®¤è¯ â¬‡ï¸
      - name: Setup node.js and OIDC Auth
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'
          scope: '@cocojs'
          always-auth: true                           # ç¡®ä¿å®ƒè¢«è®¾ç½®

      - name: Debug NODE_AUTH_TOKEN injection
        run: |
          echo "Checking NODE_AUTH_TOKEN..."
          if [ -z "$NODE_AUTH_TOKEN" ]; then
            echo "âŒ NODE_AUTH_TOKEN is NOT SET by setup-node."
            echo "   This means OIDC token acquisition failed or was skipped."
            exit 1
          else
            echo "âœ… NODE_AUTH_TOKEN is SET (Length: ${#NODE_AUTH_TOKEN})."
          fi
          echo ""
          echo "Checking .npmrc content again:"
          cat ~/.npmrc | sed 's/:_authToken=.*/:_authToken=***HIDDEN***/' || true

      - name: Install dependencies
        run: pnpm install

      # ----------------------------------------------------
      # ğŸ’¡ è°ƒè¯•æ­¥éª¤ï¼ˆå»ºè®®ä¿ç•™ï¼Œä½†ä¸è¦æ‰‹åŠ¨ä¿®æ”¹é…ç½®ï¼‰
      # ----------------------------------------------------
      - name: Verify OIDC and npm configuration
        run: |
          echo "=== Checking .npmrc file ==="
          cat ~/.npmrc | sed 's/:_authToken=.*/:_authToken=***HIDDEN***/' || true
          
          echo ""
          echo "=== Testing npm token validity ==="
          # ä½¿ç”¨ npm whoami æ£€æŸ¥æ˜¯å¦æˆåŠŸç™»å½•
          if npm whoami --registry=https://registry.npmjs.org/ 2>/dev/null; then
            echo "âœ… Authenticated successfully as: $(npm whoami --registry=https://registry.npmjs.org/)"
          else
            echo "âŒ OIDC authentication failed. Please check your npm OIDC trust relationship."
            exit 1
          fi
      # ----------------------------------------------------

      - name: Create and publish versions
        uses: changesets/action@v1
        with:
          commit: "chore: update versions"
          title: "chore: update versions"
          publish: pnpm ci:publish # ç¡®ä¿ ci:publish è„šæœ¬æ˜¯å­˜åœ¨çš„ï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨ pnpm publish
          onlyPublishWithReleaseLabel: false
        env:
          # OIDC Token ä¼šè‡ªåŠ¨é€šè¿‡ $NODE_AUTH_TOKEN æ³¨å…¥ï¼Œè¿™é‡Œåªéœ€è¦ GITHUB_TOKEN
          # ç”¨äºåˆ›å»ºå’Œæ›´æ–° PR/Commit/Tag
          GITHUB_TOKEN: ${{ secrets.COCONUT_FRAMEWORK_CREATE_PR }}
