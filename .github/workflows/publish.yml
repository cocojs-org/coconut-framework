name: Changesets

on:
  push:
    branches:
      - main

permissions:
  contents: write      # Push tags/releases
  pull-requests: write # Version PR

env:
  CI: true

jobs:
  version:
    timeout-minutes: 15
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # ä½¿ç”¨ GITHUB_TOKEN for basic checkout
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      # â¬‡ï¸ ä»…ä¾é  actions/setup-node è‡ªåŠ¨é…ç½® OIDC è®¤è¯ â¬‡ï¸
      - name: Setup node.js and OIDC Auth
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'
          scope: '@cocojs'
          always-auth: true                           # ç¡®ä¿å®ƒè¢«è®¾ç½®
          token: ${{secrets.NPM_PUBLISHER_TOKEN}}

      - name: Setup .npmrc for pnpm
        run: |
          echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > .npmrc
          echo "@cocojs:registry=https://registry.npmjs.org/" >> .npmrc
          echo "always-auth=true" >> .npmrc
        env:
          NPM_TOKEN: ${{ secrets.NPM_PUBLISHER_TOKEN }}

      - name: ğŸ” Debug .npmrc content
        run: |
          echo "::group::.npmrc file content (sensitive values are masked by GitHub)"
          cat .npmrc
          echo "::endgroup::"

      - name: Install dependencies
        run: pnpm install

      - name: Create and publish versions
        uses: changesets/action@v1
        with:
          commit: "chore: update versions"
          title: "chore: update versions"
          publish: pnpm ci:publish # ç¡®ä¿ ci:publish è„šæœ¬æ˜¯å­˜åœ¨çš„ï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨ pnpm publish
          onlyPublishWithReleaseLabel: false
        env:
          # OIDC Token ä¼šè‡ªåŠ¨é€šè¿‡ $NODE_AUTH_TOKEN æ³¨å…¥ï¼Œè¿™é‡Œåªéœ€è¦ GITHUB_TOKEN
          # ç”¨äºåˆ›å»ºå’Œæ›´æ–° PR/Commit/Tag
          GITHUB_TOKEN: ${{ secrets.COCONUT_FRAMEWORK_CREATE_PR }}
          NPM_TOKEN: ${{ secrets.NPM_PUBLISHER_TOKEN }}
